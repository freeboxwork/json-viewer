<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON to CSV Converter Online - Free JSON to CSV Tool</title>
    <meta name="description" content="Convert JSON arrays to CSV format online for free. Preview as table, choose delimiters, and download CSV files instantly.">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body>
    <script src="app.js"></script>
    <script>document.write(getNavHTML('to-csv'));</script>

    <main>
        <div class="page-header">
            <h1>JSON to CSV Converter</h1>
            <p>Convert JSON arrays to CSV format with table preview and download</p>
        </div>

        <div class="toolbar">
            <button class="btn btn-primary" onclick="convertToCSV()">&#128260; Convert to CSV</button>
            <div class="toolbar-separator"></div>
            <div class="option-group"><label>Delimiter:</label>
                <select class="select" id="delimiter"><option value="," selected>Comma</option><option value="&#9;">Tab</option><option value=";">Semicolon</option></select>
            </div>
            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;"><input type="checkbox" id="includeHeader" checked style="accent-color:var(--accent);"><span style="font-size:0.82rem;color:var(--text-secondary);">Header</span></label>
            <div class="toolbar-separator"></div>
            <button class="btn btn-secondary btn-sm" onclick="triggerUpload('jsonInput', convertToCSV)">&#128194; Upload</button>
            <button class="btn btn-secondary btn-sm" onclick="loadSampleCSV()">Sample</button>
            <button class="btn btn-secondary btn-sm" onclick="copyCSV()">&#128203; Copy</button>
            <button class="btn btn-secondary btn-sm" onclick="downloadCSV()">&#11015; Download</button>
            <button class="btn btn-danger btn-sm" onclick="clearCSV()">&#128465; Clear</button>
        </div>

        <div class="tabs">
            <button class="tab active" data-tab="input" onclick="switchTab('input')">JSON Input</button>
            <button class="tab" data-tab="output" onclick="switchTab('output')">CSV Output</button>
            <button class="tab" data-tab="table" onclick="switchTab('table')">Table Preview</button>
        </div>

        <div class="tab-body">
            <div class="tab-panel active" id="panel-input">
                <textarea class="editor-area" id="jsonInput" placeholder='Paste a JSON array here...' spellcheck="false"></textarea>
            </div>
            <div class="tab-panel" id="panel-output">
                <textarea class="editor-area" id="csvOutput" placeholder="CSV output..." readonly style="cursor:default;"></textarea>
            </div>
            <div class="tab-panel" id="panel-table">
                <div style="overflow-x:auto;padding:14px;"><table class="data-table" id="previewTable"></table></div>
            </div>
        </div>

        <div class="status-bar"><div class="status-item"><div class="status-dot neutral" id="statusDot"></div><span id="statusText">Ready</span></div></div>
    </main>

    <script>document.write(getFooterHTML());</script>

    <script>
        let csvText = '';
        setupTextareaDrop('jsonInput', convertToCSV);

        function convertToCSV() {
            const text = document.getElementById('jsonInput').value.trim();
            if (!text) { setStatus('Please enter JSON', 'invalid'); return; }
            const result = parseJSON(text);
            if (!result.success) { setStatus(`Error: ${result.error.message}`, 'invalid'); return; }
            let data = result.data;
            let statusMsg = '';
            if (!Array.isArray(data)) {
                // Find all arrays of objects in the data (top-level keys)
                const arrayEntries = [];
                function findArrays(obj, path) {
                    if (!obj || typeof obj !== 'object' || Array.isArray(obj)) return;
                    for (const [key, value] of Object.entries(obj)) {
                        const p = path ? path + '.' + key : key;
                        if (Array.isArray(value) && value.length > 0 && typeof value[0] === 'object' && value[0] !== null) {
                            arrayEntries.push({ path: p, data: value, count: value.length });
                        } else if (value && typeof value === 'object' && !Array.isArray(value)) {
                            findArrays(value, p);
                        }
                    }
                }
                findArrays(data, '');

                if (arrayEntries.length > 0) {
                    // Build array selector if not already present
                    buildArraySelector(arrayEntries);
                    // Use selected array or the largest one by default
                    const selectedPath = document.getElementById('arraySelect')?.value;
                    const selected = arrayEntries.find(a => a.path === selectedPath) || arrayEntries.sort((a, b) => b.count - a.count)[0];
                    data = selected.data;
                    statusMsg = `"${selected.path}" array (${selected.count} items)`;
                } else {
                    // No arrays found - flatten entire object as a single row
                    data = [data];
                    statusMsg = 'Flattened root object as 1 row';
                }
            } else {
                statusMsg = `${data.length} items`;
            }
            if (data.length === 0) { setStatus('Empty array', 'invalid'); return; }
            const flattened = data.map(item => flattenObject(item));
            csvText = Papa.unparse(flattened, { delimiter: document.getElementById('delimiter').value, header: document.getElementById('includeHeader').checked });
            document.getElementById('csvOutput').value = csvText;
            renderTable(flattened);
            setStatus(`Converted ${flattened.length} rows from ${statusMsg}`, 'valid');
            switchTab('output');
        }

        function buildArraySelector(entries) {
            let container = document.getElementById('arraySelectorContainer');
            if (!container) {
                container = document.createElement('div');
                container.id = 'arraySelectorContainer';
                container.className = 'option-group';
                container.style.cssText = 'margin-left:8px;';
                container.innerHTML = '<label style="font-size:0.82rem;color:var(--text-secondary);font-weight:600;">Source:</label>';
                const select = document.createElement('select');
                select.id = 'arraySelect';
                select.className = 'select';
                select.onchange = convertToCSV;
                container.appendChild(select);
                // Insert after the first toolbar separator
                const toolbar = document.querySelector('.toolbar');
                const firstSep = toolbar.querySelectorAll('.toolbar-separator')[1];
                if (firstSep) toolbar.insertBefore(container, firstSep);
                else toolbar.appendChild(container);
            }
            const select = document.getElementById('arraySelect');
            const currentVal = select.value;
            select.innerHTML = entries.map(e => `<option value="${e.path}" ${e.path === currentVal ? 'selected' : ''}>${e.path} (${e.count} items)</option>`).join('');
        }

        function flattenObject(obj, prefix = '') {
            const result = {};
            for (const [key, value] of Object.entries(obj)) {
                const newKey = prefix ? `${prefix}.${key}` : key;
                if (value !== null && typeof value === 'object' && !Array.isArray(value)) Object.assign(result, flattenObject(value, newKey));
                else if (Array.isArray(value)) result[newKey] = JSON.stringify(value);
                else result[newKey] = value;
            }
            return result;
        }

        function renderTable(data) {
            if (data.length === 0) return;
            const headers = Object.keys(data[0]);
            const maxRows = Math.min(data.length, 100);
            let html = '<thead><tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr></thead><tbody>';
            for (let i = 0; i < maxRows; i++) {
                html += '<tr>' + headers.map(h => `<td>${data[i][h] == null ? '' : String(data[i][h]).replace(/</g, '&lt;')}</td>`).join('') + '</tr>';
            }
            document.getElementById('previewTable').innerHTML = html + '</tbody>';
        }

        function loadSampleCSV() {
            document.getElementById('jsonInput').value = JSON.stringify([
                {id:1,name:"Alice",age:28,city:"Seoul",active:true},{id:2,name:"Bob",age:35,city:"Busan",active:false},
                {id:3,name:"Charlie",age:22,city:"Incheon",active:true},{id:4,name:"Diana",age:31,city:"Daegu",active:true}
            ], null, 2);
            convertToCSV();
        }

        function copyCSV() { if (!csvText) { showToast('Nothing to copy', 'error'); return; } copyToClipboard(csvText); }
        function downloadCSV() { if (!csvText) { showToast('Nothing to download', 'error'); return; } downloadFile(csvText, 'data.csv', 'text/csv'); }
        function clearCSV() { document.getElementById('jsonInput').value = ''; document.getElementById('csvOutput').value = ''; csvText = ''; document.getElementById('previewTable').innerHTML = ''; setStatus('Ready', 'neutral'); switchTab('input'); }
        function setStatus(t, type) { document.getElementById('statusText').textContent = t; document.getElementById('statusDot').className = 'status-dot ' + type; }
    </script>
</body>
</html>
